# Fail2ban jail.local configuration
# Generated by Ansible - do not edit manually

[DEFAULT]
# Ban settings
bantime = {{ fail2ban_bantime }}
findtime = {{ fail2ban_findtime }}
maxretry = {{ fail2ban_maxretry }}

# Email settings
{% if fail2ban_destemail %}
destemail = {{ fail2ban_destemail }}
sender = {{ fail2ban_sender }}
mta = {{ fail2ban_mta }}
action = %(action_mwl)s
{% else %}
action = %(action_)s
{% endif %}

# Ignored IP addresses
ignoreip = {{ (fail2ban_ignoreip + fail2ban_ignoreip_extra) | join(' ') }}

# Backend
backend = {{ fail2ban_backend }}

# Database
{% if fail2ban_dbfile %}
dbfile = {{ fail2ban_dbfile }}
dbpurgeage = {{ fail2ban_dbpurgeage }}
{% endif %}

# SSH Protection
[sshd]
enabled = {{ fail2ban_ssh_enabled | default(true) | lower }}
port = {{ fail2ban_services.ssh.port }}
filter = {{ fail2ban_services.ssh.filter }}
logpath = {{ fail2ban_log_paths.ssh }}
maxretry = {{ fail2ban_services.ssh.maxretry }}

{% if fail2ban_nginx_enabled | default(false) %}
# Nginx HTTP Authentication
[nginx-http-auth]
enabled = true
port = {{ fail2ban_services.nginx.port }}
filter = {{ fail2ban_services.nginx.filter }}
logpath = {{ fail2ban_log_paths.nginx }}
maxretry = {{ fail2ban_services.nginx.maxretry }}

# Nginx HTTP Flood Protection
[nginx-http-flood]
enabled = true
port = http,https
filter = nginx-http-flood
logpath = {{ fail2ban_log_paths.nginx }}
maxretry = 20
findtime = 60
bantime = {{ fail2ban_bantime }}

# Nginx Request Limit
[nginx-req-limit]
enabled = true
port = http,https
filter = nginx-req-limit
logpath = {{ fail2ban_log_paths.nginx }}
maxretry = 10
findtime = 60
bantime = {{ fail2ban_bantime }}
{% endif %}

{% if fail2ban_apache_enabled | default(false) %}
# Apache HTTP Authentication
[apache-auth]
enabled = true
port = {{ fail2ban_services.apache.port }}
filter = {{ fail2ban_services.apache.filter }}
logpath = {{ fail2ban_log_paths.apache }}
maxretry = {{ fail2ban_services.apache.maxretry }}

# Apache HTTP Flood Protection
[apache-http-flood]
enabled = true
port = http,https
filter = apache-http-flood
logpath = {{ fail2ban_log_paths.apache }}
maxretry = 20
findtime = 60
bantime = {{ fail2ban_bantime }}

# Apache DoS Protection
[apache-dos]
enabled = true
port = http,https
filter = apache-dos
logpath = {{ fail2ban_log_paths.apache }}
maxretry = 400
findtime = 300
bantime = {{ fail2ban_bantime }}
{% endif %}

{% if fail2ban_ftp_enabled | default(false) %}
# FTP Protection
[vsftpd]
enabled = true
port = {{ fail2ban_services.ftp.port }}
filter = {{ fail2ban_services.ftp.filter }}
logpath = {{ fail2ban_log_paths.vsftpd }}
maxretry = {{ fail2ban_services.ftp.maxretry }}

[proftpd]
enabled = true
port = ftp,ftp-data,ftps,ftps-data
filter = proftpd
logpath = {{ fail2ban_log_paths.proftpd }}
maxretry = 6
{% endif %}

{% if fail2ban_sftp_enabled | default(false) %}
# SFTP Protection (enhanced SSH monitoring for file transfers)
[sftp]
enabled = true
port = {{ fail2ban_services.sftp.port }}
filter = sshd
logpath = {{ fail2ban_log_paths.ssh }}
maxretry = {{ fail2ban_services.sftp.maxretry }}
bantime = {{ fail2ban_bantime }}
findtime = 300
{% endif %}

{% for jail_name, jail_config in fail2ban_custom_jails.items() %}
# Custom jail: {{ jail_name }}
[{{ jail_name }}]
enabled = {{ jail_config.enabled | default(true) | lower }}
port = {{ jail_config.port }}
filter = {{ jail_config.filter }}
logpath = {{ jail_config.logpath }}
maxretry = {{ jail_config.maxretry | default(fail2ban_maxretry) }}
{% if jail_config.bantime is defined %}
bantime = {{ jail_config.bantime }}
{% endif %}
{% if jail_config.findtime is defined %}
findtime = {{ jail_config.findtime }}
{% endif %}

{% endfor %}

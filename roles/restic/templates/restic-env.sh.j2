#!/bin/bash
# Restic Environment Setup Script
# Usage: source /opt/restic/restic-env.sh

# Repository configuration
export RESTIC_REPOSITORY="{{ restic_repository_url }}/{{ inventory_hostname }}"
export RESTIC_PASSWORD="{{ restic_repository_password }}"
export RESTIC_CACHE_DIR="{{ restic_cache_path }}"

{% if restic_repository_type == 's3' %}
# AWS S3 configuration
export AWS_ACCESS_KEY_ID="{{ restic_aws_access_key_id }}"
export AWS_SECRET_ACCESS_KEY="{{ restic_aws_secret_access_key }}"
{% endif %}

{% if restic_repository_type == 'b2' %}
# Backblaze B2 configuration
export B2_ACCOUNT_ID="{{ restic_b2_account_id }}"
export B2_ACCOUNT_KEY="{{ restic_b2_account_key }}"
{% endif %}

# Additional restic options
export RESTIC_PROGRESS="true"
export RESTIC_COMPRESSION="auto"

# Convenience aliases for common operations
alias restic-snapshots='restic snapshots'
alias restic-ls='restic ls latest'
alias restic-check='restic check'
alias restic-stats='restic stats'
alias restic-mount='restic mount'
alias restic-backup-paths='echo "Backup paths: {{ restic_backup_paths | join(", ") }}"'

# Helper functions
restic-restore() {
    if [ -z "$1" ] || [ -z "$2" ]; then
        echo "Usage: restic-restore <snapshot-id> <target-directory>"
        echo "Example: restic-restore latest /tmp/restore"
        return 1
    fi
    restic restore "$1" --target "$2"
}

restic-find() {
    if [ -z "$1" ]; then
        echo "Usage: restic-find <pattern>"
        echo "Example: restic-find '*.sql'"
        return 1
    fi
    restic find "$1"
}

restic-host-snapshots() {
    restic snapshots --tag "host:{{ inventory_hostname }}"
}

restic-database-snapshots() {
    restic snapshots --tag "database"
}

restic-path-snapshots() {
    if [ -z "$1" ]; then
        echo "Usage: restic-path-snapshots <path>"
        echo "Example: restic-path-snapshots var-www"
        return 1
    fi
    restic snapshots --tag "path:$1"
}

restic-backup-manual() {
    echo "Running manual backup for {{ inventory_hostname }}..."
    {{ restic_scripts_path }}/scripts/backup.sh
}

# Display configuration info
echo "ðŸ”§ Restic environment loaded for {{ inventory_hostname }}"
echo "ðŸ“¦ Repository: {{ restic_repository_url }}/{{ inventory_hostname }}"
echo "ðŸ’¾ Cache: {{ restic_cache_path }}"
echo ""
echo "ðŸš€ Available commands:"
echo "  restic-snapshots          - List all snapshots"
echo "  restic-host-snapshots     - List snapshots for this host"
echo "  restic-database-snapshots - List database snapshots"
echo "  restic-path-snapshots     - List snapshots for specific path"
echo "  restic-ls                 - List files in latest snapshot"
echo "  restic-check              - Check repository integrity"
echo "  restic-stats              - Show repository statistics"
echo "  restic-backup-paths       - Show configured backup paths"
echo "  restic-backup-manual      - Run manual backup"
echo "  restic-restore <id> <dir> - Restore snapshot to directory"
echo "  restic-find <pattern>     - Find files matching pattern"
echo ""
echo "ðŸ’¡ Or use restic directly: restic <command>"
echo "ðŸ“š Example: restic snapshots --tag 'database'"
